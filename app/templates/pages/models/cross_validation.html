{% extends "common/dark_base.html" %}

{% block content %}

<ol class="breadcrumb">
    <li class="breadcrumb-item">Home</li>
    <li class="breadcrumb-item"><a href="{{ url_for('main.project_page') }}">Projects</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('main.my_project_page', project_id=my_data.project.id) }}">{{my_data.project.name}}</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('data.data_details_page', data_id=my_data.id) }}">{{my_data.name}}</a></li>
    <li class="breadcrumb-item"><a href={{ url_for( 'model.model_details_page', model_id=my_model.id) }}>{{my_model.name}}</a></li>
    <li class="breadcrumb-item active">Cross Validation</li>
</ol>

<div class="container-fluid">
    <div class="animated fadeIn">
        <div class="card ">
            <div class="card-header">
                <strong>Cross Validation: {{my_model.name}}</strong>
            </div>
            <div class="card-body">
                <div class="panel" style="padding-top: 10px; padding-bottom: 20px;">
                    <div class="panel-body">
                        <div class="card ">
                            <div class="card-header">
                                <strong>Performance Summary</strong>
                            </div>
                            <div class="card-body">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Cross Validation File</th>
                                            <th>Number of Examples</th>
                                            <th>Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <th scope="row"><a href="{{ url_for('model.download', filename=filename, model_id=my_model.id) }}">{{filename}}</a></th>
                                            <td>{{examples}}</td>
                                            <tD>File was generated using leave-one-out-cross-validation (LOOCV).</tD>
                                        </tr>
                                    </tbody>
                                </table>
                                {% if my_model.features['model_class'] == "predictor" %}
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>99% Confidence</th>
                                            <th>95% Confidence</th>
                                            <th>90% Confidence</th>
                                            <th>85% Confidence</th>
                                            <th>80% Confidence</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>+/- {{to_render['confidence_99'] | round(4)}}</td>
                                            <td>+/- {{to_render['confidence_95'] | round(4)}}</td>
                                            <td>+/- {{to_render['confidence_90'] | round(4)}}</td>
                                            <td>+/- {{to_render['confidence_85'] | round(4)}}</td>
                                            <td>+/- {{to_render['confidence_80'] | round(4)}}</td>
                                        </tr>
                                    </tbody>
                                </table>
                                {% endif %} {% if my_model.features['model_class'] != "predictor" %}
                                <br>
                                <br>
                                <h6>Model Performance</h6>
                                <table class="table table-hover table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th>F1 Score</th>
                                            <th>Recall</th>
                                            <th>Precision</th>
                                            <th>Accuracy</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            {% if results["f1_score"] != None %}
                                            <td>{{results["f1_score"] | round(4)}}</td>
                                            {% else %}
                                            <td>None</td>
                                            {% endif %} {% if results["recall"] != None %}
                                            <td>{{results["recall"] | round(4)}}</td>
                                            {% else %}
                                            <td>None</td>
                                            {% endif %} {% if results["precision"] != None %}
                                            <td>{{results["precision"] | round(4)}}</td>
                                            {% else %}
                                            <td>None</td>
                                            {% endif %} {% if results["accuracy"] != None %}
                                            <td>{{results["accuracy"] | round(4)}}</td>
                                            {% else %}
                                            <td>None</td>
                                            {% endif %}
                                        </tr>
                                    </tbody>
                                </table>
                                {% endif %}
                            </div>
                            <div class="card-footer "></div>
                        </div>
                        <div class="card ">
                            <div class="card-header">
                                <strong>Prediction Analysis</strong>
                            </div>
                            <div class="card-body">
                                 {% if my_model.features['model_class'] == "predictor" %}
                                    <div class="card ">
                                        <div class="card-header">
                                            <strong></strong>
                                        </div>
                                        <div class="card-body">
                                            <div id="container6" style="height: 200px; margin: 0 auto"></div>
                                        </div>
                                        <div class="card-footer "></div>
                                    </div>                                 
                                    <div class="card ">
                                        <div class="card-header">
                                            <strong></strong>
                                        </div>
                                        <div class="card-body">
                                            <div id="container" style="height: 400px; margin: auto; max-width: 600px"></div>
                                        </div>
                                        <div class="card-footer "></div>
                                    </div>                                          
                                     <div class="card ">
                                        <div class="card-header">
                                            <strong></strong>
                                        </div>
                                        <div class="card-body">
                                            <div id="container2" style="height: 400px; margin: 0 auto"></div>
                                        </div>
                                        <div class="card-footer "></div>
                                    </div>                                      
                                     <div class="card ">
                                        <div class="card-header">
                                            <strong></strong>
                                        </div>
                                        <div class="card-body">
                                            <div id="container3" style="height: 400px; margin: 0 auto"></div>
                                        </div>
                                        <div class="card-footer "></div>
                                    </div>                                       
                                     <div class="card ">
                                        <div class="card-header">
                                            <strong></strong>
                                        </div>
                                        <div class="card-body">
                                            <div id="container4" style="height: 400px; max-width: 800px; margin: 0 auto"></div>
                                        </div>
                                        <div class="card-footer "></div>
                                    </div>                                      
                                     <div class="card ">
                                        <div class="card-header">
                                            <strong></strong>
                                        </div>
                                        <div class="card-body">
                                            <div id="container5" style="height: 400px; margin: 0 auto"></div>
                                        </div>
                                        <div class="card-footer "></div>
                                    </div>                                      
                                    {% else %}
                                    <div class="card ">
                                        <div class="card-header">
                                            <strong></strong>
                                        </div>
                                        <div class="card-body">
                                            <div id="container" style="height: 400px; max-width: 600px; margin: 0 auto"></div>
                                        </div>
                                        <div class="card-footer "></div>
                                    </div>                                                                          
                                    {% endif %} 
                                    {% if my_model.features['model_class'] != "predictor" %}
                                    <div class="card ">
                                        <div class="card-header">
                                            <strong></strong>
                                        </div>
                                        <div class="card-body">
                                            <div id="container_class" style="height: 400px; margin: 0 auto; margin-top: 20px;"></div>
                                        </div>
                                        <div class="card-footer "></div>
                                    </div>                                      
                                    <div class="card ">
                                        <div class="card-header">
                                            <strong>Truth Table</strong>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-hover table-striped table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>Expected Value</th>
                                                        <th>Predicted Value</th>
                                                        <th>Quantity</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for k, v in truth_table.iteritems() %}
                                                    <tr>
                                                        <td>{{k[0]}}</td>
                                                        <td>{{k[1]}}</td>
                                                        <tD>{{v}}</tD>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="card-footer "></div>
                                    </div>                                       

                                    {% endif %}                                
                            </div>
                            <div class="card-footer "></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer "></div>
        </div>
    </div>
</div>

<script>
    {% if my_model.features['model_class'] != "predictor" %}
    Highcharts.chart('container_class', {
        chart: {
            type: 'column'
        },
        credits: {
            enabled: false
        },
        title: {
            text: 'Model Performance by Outcome'
        },
        xAxis: {
            categories: [
                '(Expected, Predicted)'
            ],
            crosshair: true
        },
        yAxis: {
            min: 0,
            title: {
                text: 'Counts'
            }
        },
        tooltip: {
            headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
            pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                '<td style="padding:0"><b>{point.y:.1f}</b></td></tr>',
            footerFormat: '</table>',
            shared: true,
            useHTML: true
        },
        plotOptions: {
            column: {
                pointPadding: 0.2,
                borderWidth: 0
            }
        },

        series: [        {% for k, v in truth_table.iteritems() %}
            {
                name: '({{k[0]}}, {{k[1]}})',
                data: [{{v}}]

            },
        {% endfor %} ]
    });
    {% endif %}
    {% if my_model.features['model_class'] == "predictor" %}
        Highcharts.chart('container6', {
        chart: {
            type: 'bar'
        },
        credits: {
            enabled: false
        },
        title: {
            text: '(r-squared) Explained vs. Unexplained Variance'
        },
        xAxis: {
            categories: ['Variance']
        },
        yAxis: {
            min: 0,
            title: {
                text: 'Explained vs. Unexplained'
            }
        },
        legend: {
            reversed: true
        },
        plotOptions: {
            series: {
                stacking: 'normal'
            }
        },
        series: [{
            name: 'Explained',
            data: [{{to_render['explained_variance']}}]
        }, {
            name: 'Unexplained',
            data: [{{to_render['unexplained']}}]
        }]
    });
        Highcharts.chart('container5', {
            title: {
                text: 'Variance Histogram'
            },
            credits: {
                enabled: false
            },
            xAxis: [{
                title: { text: 'Bin' },
                alignTicks: false
            }, {
                title: { text: 'Range' },
                alignTicks: false,
                opposite: true
            }],

            yAxis: [{
                title: { text: 'Count' }
            }, {
                title: { text: 'Variance Score' },
                opposite: true
            }],

            series: [{
                name: 'Predictions',
                type: 'histogram',
                xAxis: 1,
                yAxis: 1,
                baseSeries: 's1',
                zIndex: -1
            }, {
                name: 'Variance',
                type: 'scatter',
                data: {{sorted_variance | safe}},
                id: 's1',
                marker: {
                    radius: 1.5
                }
            }]
        });
        Highcharts.chart('container', {

            chart: {
                type: 'boxplot'
            },
            credits: {
                enabled: false
            },

            title: {
                text: 'Box Plot'
            },

            legend: {
                enabled: false
            },

            xAxis: {
                categories: ['Original Data', 'Predicted'],
                title: {
                    text: '{{col_name}}'
                }
            },

            yAxis: {
                title: {
                    text: 'Observations'
                },
                plotLines: [{
                    value: {{to_render['orig']["median"]}},
                    color: 'red',
                    width: 1,
                    label: {
                        text: 'Sample Median: {{to_render['orig']["median"]}}',
                        align: 'center',
                        style: {
                            color: 'gray'
                        }
                    }
                }]
            },

            series: [{
                name: 'Observations',
                data: [
                    [{{to_render['orig']["min"]}}, {{to_render['orig']["lower"]}}, {{to_render['orig']["median"]}}, {{to_render['orig']["upper"]}}, {{to_render['orig']["max"]}}],
                    [{{to_render['predicted']["min"]}}, {{to_render['predicted']["lower"]}}, {{to_render['predicted']["median"]}}, {{to_render['predicted']["upper"]}}, {{to_render['predicted']["max"]}}]
                ],
                tooltip: {
                    headerFormat: '<em>{point.key}</em><br/>'
                }
            }]

        });
        Highcharts.chart('container3', {

            chart: {
                type: 'boxplot'
            },
            credits: {
                enabled: false
            },

            title: {
                text: 'Prediction Delta'
            },

            legend: {
                enabled: false
            },

            xAxis: {
                categories: ['Variance'],
                title: {
                    text: 'Score Delta'
                }
            },

            yAxis: {
                title: {
                    text: 'Score Delta'
                }
            },

            series: [{
                name: 'Score Delta',
                data: [
                    [{{to_render['variance']["min"]}}, {{to_render['variance']["lower"]}}, {{to_render['variance']["median"]}}, {{to_render['variance']["upper"]}}, {{to_render['variance']["max"]}}]
                ],
                tooltip: {
                    headerFormat: '<em>{point.key}</em><br/>'
                }
            }, {
                name: 'Outlier',
                color: Highcharts.getOptions().colors[0],
                type: 'scatter',
                data: {{to_render["outliers"] | safe}},
                marker: {
                    fillColor: 'white',
                    lineWidth: 1,
                    lineColor: Highcharts.getOptions().colors[0]
                },
                tooltip: {
                    pointFormat: 'Observation: {point.y}'
                }
            }]

        });
        Highcharts.chart('container2', {
            chart: {
                type: 'area'
            },
            credits: {
                enabled: false
            },
            title: {
                text: 'Data Shape'
            },
            xAxis: {
                allowDecimals: false,
                labels: {
                    formatter: function () {
                        return this.value; // clean, unformatted number for year
                    }
                }
            },
            yAxis: {
                title: {
                    text: 'Target Score'
                },
                labels: {
                    formatter: function () {
                        return this.value;
                    }
                }
            },
            tooltip: {
                pointFormat: 'Value {point.y:,.0f}'
            },
            plotOptions: {
                area: {
                    pointStart: 0,
                    marker: {
                        enabled: false,
                        symbol: 'circle',
                        radius: 2,
                        states: {
                            hover: {
                                enabled: true
                            }
                        }
                    }
                }
            },
            series: [{
                name: 'Original',
                data: {{norig_data}}
            }, {
                name: 'Predicted',
                data: {{npredicted_data}}
            }, {
                name: 'Residuals',
                data: {{variance}}
            }]
        });

        Highcharts.chart('container4', {
            chart: {
                type: 'scatter',
                zoomType: 'xy'
            },
            credits: {
                enabled: false
            },
            title: {
                text: 'Actual vs. Predicted Score'
            },
            subtitle: {
                text: '{{col_name}}'
            },
            xAxis: {
                title: {
                    enabled: true,
                    text: 'Actual'
                },
                startOnTick: true,
                endOnTick: true,
                showLastLabel: true
            },
            yAxis: {
                title: {
                    text: 'Predicted'
                }
            },
            legend: {
                layout: 'vertical',
                align: 'left',
                verticalAlign: 'top',
                x: 100,
                y: 70,
                floating: true,
                backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF',
                borderWidth: 1
            },
            plotOptions: {
                scatter: {
                    marker: {
                        radius: 5,
                        states: {
                            hover: {
                                enabled: true,
                                lineColor: 'rgb(100,100,100)'
                            }
                        }
                    },
                    states: {
                        hover: {
                            marker: {
                                enabled: false
                            }
                        }
                    },
                    tooltip: {
                        headerFormat: '<b>{series.name}</b><br>',
                        pointFormat: '{point.x} actual, {point.y} predicted'
                    }
                }
            },
            series: [{
                name: '{{col_name}}',
                color: 'rgba(119, 152, 191, .5)',
                data: {{to_render['scatter']}}

            }]
        });
{% else %}
    Highcharts.chart('container', {
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false,
            type: 'pie'
        },
        credits: {
            enabled: false
        },
        title: {
            text: 'Model Accuracy'
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                    style: {
                        color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                    }
                }
            }
        },
        series: [{
            name: 'Accuracy',
            colorByPoint: true,
            data: [{
                name: 'Correct',
                y: {{to_render['accuracy']['total_correct']}}
            }, {
                name: 'Incorrect',
                y: {{to_render['accuracy']['total_missed']}},
                sliced: true,
                selected: true
            }]
        }]
    });
{% endif %}
</script>
{% endblock %}
